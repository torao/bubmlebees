# Basic Structure


## Messages and Their Encoding

整数値は Little Endian でエンコードされます。

### Binary Encoding

任意長のバイナリは length-data 形式でエンコードされます。0 から 65,535 バイトのバイト列をエンコードできますが、エンコードされたメッセージの
長さの上限が 65,507 バイトであることからそれより短いバイト値しか格納できません。

| Name   | Bytes  | Type    |
|:-------|-------:|:--------|
| length | 2      | uint16  |
| bytes  | length | uint8[] |

### Open Message

| Name        | Bytes | Type   |
|:------------|------:|:-------|
| pipe_id     |     2 | uint16 |
| function_id |     2 | uint16 |
| priority    |     1 | uint8  |
| params      |     * | binary |

### Close Message

| Name        | Bytes | Type   |
|:------------|------:|:-------|
| pipe_id     |     2 | uint16 |
| bit_field   |     1 | uint8  |
| result      |     * | binary |

`bit_field` の最下位ビットが処理の成功か失敗かを表しており、それ以外のビットは無視されます。

| Name      | Bits |
|:----------|-----:|
| (ignored) |    7 |
| failure   |    1 |

処理が成功している場合 (すなはち `failure=0`)、`result` フィールドの値は処理結果を表します。処理が失敗した場合 (すなはち `failure=1`)、
`result` フィールドの値はエラー状況を知らせる情報を合わします。いずれの場合も `result` をどのようにエンコードするかは上位レイヤーでの取り決め
となります。

### Block Message

Block メッセージはオープンしているパイプ間でフラグメント化されたデータをやり取りするために使用します。

| Name        | Bytes | Type   |
|:------------|------:|:-------|
| pipe_id     |     2 | uint16 |
| bit_field   |     1 | uint8  |
| payload     |     * | binary |

`bit_field` は下位 7 ビットが損失許容確率を表し、最上位の 1 ビットがこのブロックでストリームが終了するかを表している。

| Name | Bits |
|:-----|-----:|
| eof  |    1 |
| loss |    7 |

損失許容確率 `loss` は転送中にこの Block メッセージを破棄しても良い確率を示す 0～127 までの値です。このフィールドはアプリケーションや
ネットワークの過負荷によってすべての Block を処理できなくなったときに参照されることを想定しています。値 0 (デフォルト) はどのような状況
であってもこのブロックを消失させてはならないことを意味し、127 は 100% の消失が発生しても良いことを意味しています。Block の `eof` を
1 にする場合は必ず `loss=0` にしなければならず、また `eof=1` のブロックは `loss=0` とみなさなければならない。

この損失許容確率は一回の破棄判定における確率を表しています。つまり、この確率を複数回の破棄判定に適用すると、設定者が意図した損失確率と異なる
結果をもたらします。したがって、破棄判定を通過した Block は `loss=0` に更新されなければならない。